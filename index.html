<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mfumo wa Kuchangisha Harusi - Julius Herman</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Google Fonts for modern fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #ff6f91; /* Pastel pink */
            --secondary-color: #ffd700; /* Gold */
            --light-color: #f5eef8;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --sparkle-color: #ffd700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
      /* Modern Loading Spinner Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(52, 152, 219, 0.85), rgba(155, 89, 182, 0.85));
    backdrop-filter: blur(8px);
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 2000;
    opacity: 1;
    transition: opacity 0.8s ease-in-out;
}

/* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
            opacity: 1;
            transition: opacity 1s ease;
        }
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .spinner-ring {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.2);
            border-top: 8px solid white;
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }
        
        .spinner-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .welcome-message {
            color: white;
            font-size: 2rem;
            font-family: 'Great Vibes', cursive;
            margin-top: 1.5rem;
            animation: fadeIn 2s ease-in-out;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .loading-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--sparkle-color);
            border-radius: 50%;
            animation: confetti 4s ease-in-out infinite;
        }
        
        .loading-particle:nth-child(1) { left: 20%; animation-delay: 0s; }
        .loading-particle:nth-child(2) { left: 40%; animation-delay: 0.5s; }
        .loading-particle:nth-child(3) { left: 60%; animation-delay: 1s; }
        .loading-particle:nth-child(4) { left: 80%; animation-delay: 1.5s; }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-150px) rotate(180deg); opacity: 0.5; }
            100% { transform: translateY(-300px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        /* Lock Message */
        .lock-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark-color); /* Solid background */
            z-index: 1500;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            text-align: center;
            padding: 2rem;
        }
        
        .lock-message.active {
            display: flex;
        }
        
        /* Announcement Modal */
        .announcement-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .announcement-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .announcement-content h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .announcement-content p {
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            position: relative;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header h1 {
    font-family: 'Montserrat', sans-serif;
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    animation: slideIn 2s ease-in-out;
}
        
        header p {
            font-size: 1.2rem;
            font-family: 'Montserrat', sans-serif;
            animation: slideIn 2.5s ease-in-out;
        }
        
        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--sparkle-color);
            border-radius: 50%;
            animation: sparkle 5s infinite ease-in-out;
        }
        
        .sparkle:nth-child(1) { left: 15%; animation-delay: 0s; }
        .sparkle:nth-child(2) { left: 35%; animation-delay: 1s; }
        .sparkle:nth-child(3) { left: 55%; animation-delay: 2s; }
        .sparkle:nth-child(4) { left: 75%; animation-delay: 3s; }
        
        @keyframes slideIn {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes sparkle {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            50% { transform: translateY(-50px) scale(1.5); opacity: 0.4; }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            background-color: var(--dark-color);
            margin-bottom: 1rem;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .nav-tab {
            padding: 0.8rem 1.5rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .nav-tab:hover, .nav-tab.active {
            background-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            padding: 1.5rem;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard {
            text-align: center;
        }
        
        .dashboard-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        
        .days-remaining {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin: 1rem 0;
            font-weight: bold;
        }
        
        .summary-cards {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 1.5rem 0;
            gap: 1rem;
        }
        
        .summary-card {
            background: white;
            border-radius: 5px;
            padding: 1rem;
            width: 45%;
            min-width: 200px;
            margin: 0.5rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .summary-card h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .summary-card p {
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            width: 100%;
            margin-top: 0.5rem;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        th, td {
            padding: 0.7rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .paid {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .pending {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        .partial {
            color: #e67e22;
            font-weight: bold;
        }
        
        footer {
            text-align: center;
            padding: 1rem 0;
            background-color: var(--dark-color);
            color: white;
            margin-top: 1.5rem;
            font-size: 0.8rem;
        }
       
        .loading {
    text-align: center;
    padding: 2rem;
    font-style: normal; /* Badilisha kutoka italic hadi normal */
    color: #666;
}
        .success-modal, .announcement-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .success-content, .announcement-content {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .success-content h3, .announcement-content h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        
        .success-content p, .announcement-content p {
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .close-modal {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .duplicate-warning, .error-message {
            color: var(--warning-color);
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        .payment-form, .admin-panel {
            display: none;
            margin-top: 1rem;
        }
        
        .payment-form.active, .admin-panel.active {
            display: block;
        }
        
        .logout-btn, .print-btn {
            background-color: var(--warning-color);
            margin-top: 1rem;
        }
        
        /* Mobile-Friendly Table */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: row;
                overflow-x: auto;
            }
            
            .nav-tab {
                font-size: 0.8rem;
                padding: 0.5rem 1rem;
            }
            
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            th, td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .status-table-container {
                overflow-x: auto;
            }
            
            .form-group {
                margin-bottom: 1rem;
            }
            
            .form-group input, .form-group select, .form-group textarea {
                font-size: 0.8rem;
            }
            
            button {
                font-size: 0.9rem;
                padding: 0.6rem 1rem;
            }
            
            .summary-card {
                width: 100%;
                min-width: 150px;
            }
            
            .success-content, .announcement-content {
                width: 90%;
                max-width: 300px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            header p, .days-remaining {
                font-size: 1rem;
            }
            
            .welcome-message {
                font-size: 1.5rem;
            }
        }
        
        @media (min-width: 768px) {
            header h1 {
                font-size: 3.5rem;
            }
            
            header p {
                font-size: 1.5rem;
            }
            
            .nav-tab {
                padding: 1rem 2rem;
                font-size: 1rem;
            }
            
            .tab-content {
                padding: 2rem;
                margin-bottom: 2rem;
            }
            
            .dashboard-image {
                max-height: 400px;
            }
            
            .summary-card {
                width: 30%;
                min-width: 250px;
            }
            
            .form-group input, .form-group select, .form-group textarea {
                font-size: 1rem;
            }
            
            button {
                font-size: 1rem;
                width: auto;
            }
            
            table {
                font-size: 1rem;
            }
            
            th, td {
                padding: 1rem;
            }
            
            .success-content, .announcement-content {
                width: 400px;
            }
            
            .welcome-message {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner-container">
            <div class="spinner-ring"></div>
            <i class="fas fa-heart spinner-heart"></i>
        </div>
        <div class="welcome-message">Karibu kwenye Harusi ya Julius Herman!</div>
        <div class="loading-particle"></div>
        <div class="loading-particle"></div>
        <div class="loading-particle"></div>
        <div class="loading-particle"></div>
    </div>
    
    <!-- Lock Message -->
    <div class="lock-message" id="lock-message">
        <p>🚨🚨 Mfumo umefungwa kutokana na tatizo la kiufundi. Tafadhali wasiliana na Faraja Herman kupitia namba ya simu +255 760 059 612. Mfumo utafunguliwa mara baada ya marekebisho kukamilika🚨🚨

</p>
    </div>
    
    <!-- Announcement Modal -->
    <div class="announcement-modal" id="announcement-modal">
        <div class="announcement-content">
            <h3>Tangazo</h3>
            <p id="announcement-text"></p>
            <button class="close-modal" onclick="hideAnnouncementModal()">Sawa</button>
        </div>
    </div>
    
    <header>
        <div class="container">
            <h1>KAMATI KUU YA HARUSI</h1>
            <p>Tarehe: Oktoba 3, 2025</p>
            <div class="sparkle"></div>
            <div class="sparkle"></div>
            <div class="sparkle"></div>
            <div class="sparkle"></div>
        </div>
    </header>
    
    <div class="nav-tabs">
        <div class="nav-tab active" data-tab="dashboard">Dashboard</div>
        <div class="nav-tab" data-tab="register">Usajiri</div>
        <div class="nav-tab" data-tab="contributors">Waliochangia</div>
        <div class="nav-tab" data-tab="status">Hali ya Michango</div>
        <div class="nav-tab" data-tab="payment"> Fanya Malipo</div>
        <div class="nav-tab" data-tab="admin"> ADMIN</div>
    </div>
    
    <div class="container">
        <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
            <div class="dashboard">
                <img src="https://images.unsplash.com/photo-1583939003579-730e3918a45a?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="Harusi" class="dashboard-image">
               <h2>Familia ya Herman Andrea</h2>
<p>Wanayo furaha kubwa kuwakalibisheni ndugu wote kushiriki katika mchango wa kamati ya ufanisi wa harusi ya ndugu Julius &amp; Monica itakayofanyika tarehe 3/10/2025.</p>
<p>Mchango wako ndio mafanikio. Asanteni.</p>
                <p class="days-remaining" id="days-remaining">Siku zinazobaki: Inapakia...</p>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Jumla ya waliotoa</h3>
                        <p id="total-contributors">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Jumla ya pesa iliyotolewa</h3>
                        <p id="total-amount">TSh 0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Waliomaliza Kulipa</h3>
                        <p id="paid-contributors">0</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Registration Tab -->
        <div id="register" class="tab-content">
            <h2>Fomu ya Kujisajiri</h2>
<p>Jaza taarifa zako hapa chini kwa ajili ya kuchangia harusi.</p>
<p style="color: red; font-weight: bold; font-size: 1.1rem;">
  "Tafadhali jisajili mara moja tu! Usijirudie kujisajili."
</p>
            <form id="registration-form">
                <div class="form-group">
                    <label for="firstName">Jina la Kwanza</label>
                    <input type="text" id="firstName" required>
                </div>
                
                <div class="form-group">
                    <label for="middleName">Jina la Kati</label>
                    <input type="text" id="middleName">
                </div>
                
                <div class="form-group">
                    <label for="lastName">Jina la Mwisho</label>
                    <input type="text" id="lastName" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Namba ya Simu</label>
                    <input type="tel" id="phone" required>
                    <div id="phone-warning" class="duplicate-warning">Mtu mmoja tayari amejisajiriwa kwa namba hii!</div>
                </div>
                
                <div class="form-group">
                    <label for="region">Mkoa</label>
                    <textarea id="region" rows="3" placeholder="Andika mkoa unaoohusika..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="amount">Kiasi Unachotaka Kuchangia (TSh)</label>
                    <input type="number" id="amount" required min="1000">
                </div>
                
                <button type="submit" id="submit-btn">Wasilisha</button>
                <div id="form-error" class="error-message"></div>
            </form>
        </div>
        
        <!-- Contributors Tab -->
        <div id="contributors" class="tab-content">
            <h2>Orodha ya Wachangiaji</h2>
            <p>Hii ni orodha ya wote waliojitolea kuchangia harusi.</p>
            
            <div id="contributors-loading" class="loading">Inapakia data...</div>
            <table id="contributors-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Jina Kamili</th>
                        <th>Mkoa</th>
                        <th>Simu</th>
                        <th>Kiasi</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <!-- Status Tab -->
        <div id="status" class="tab-content">
            <h2>Hali ya Michango</h2>
            <p>Orodha ya waliotoa mchango na wale ambao bado.</p>
            
            <div class="form-group">
                <label for="status-filter">Chuja kwa Hali:</label>
                <select id="status-filter">
                    <option value="all">Wote</option>
                    <option value="paid">Waliolipa</option>
                    <option value="partial">Waliotanguliza</option>
                    <option value="pending">Wasiomaliza</option>
                </select>
            </div>
            
            <div id="status-loading" class="loading">Inapakia data...</div>
            <div class="status-table-container">
                <table id="status-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Jina Kamili</th>
                            <th>Kiasi cha Ahadi</th>
                            <th>Kiasi Kilicholipwa</th>
                            <th>Deni</th>
                            <th>Hali</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Payment Tab -->
        <div id="payment" class="tab-content">
            <h2>Fanya Malipo</h2>
            <p>Jaza taarifa za malipo yako hapa chini.</p>
            
            <form id="payment-form">
                <div class="form-group">
                    <label for="contributor-select">Chagua Jina Lako</label>
                    <select id="contributor-select" required>
                        <option value="">Chagua Jina</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="payment-type">Aina ya Malipo</label>
                    <select id="payment-type" required>
                        <option value="full">Amelipa Yote</option>
                        <option value="partial">Ametanguliza</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="payment-amount">Kiasi (TSh)</label>
                    <input type="number" id="payment-amount" required min="0">
                    <div id="debt-info" class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="payment-date">Tarehe ya Malipo</label>
                    <input type="date" id="payment-date" required>
                </div>
                
                <div class="form-group">
                    <label for="payment-details">Maelezo Mafupi</label>
                    <textarea id="payment-details" rows="3" placeholder="Andika maelezo mafupi (mfano: Malipo kupitia M-Pesa)"></textarea>
                </div>
                
                <button type="submit" id="payment-submit-btn">Hifadhi Malipo</button>
                <div id="payment-error" class="error-message"></div>
            </form>
        </div>
        
        <!-- Admin Tab -->
        <div id="admin" class="tab-content">
            <h2>Paneli ya Admin</h2>
            
            <div id="admin-login" class="form-group">
                <label for="admin-password">Ingiza Nenosiri la Admin</label>
                <input type="password" id="admin-password">
                <button onclick="verifyAdminPassword()">Thibitisha</button>
                <div id="admin-error" class="error-message"></div>
            </div>
            
            <div id="admin-panel" class="admin-panel">
                <h3>Dhibiti Mfumo</h3>
                
                <div class="form-group">
                    <label for="announcement">Tangazo</label>
                    <textarea id="announcement" rows="4" placeholder="Andika tangazo hapa..."></textarea>
                    <button onclick="postAnnouncement()">Chapisha Tangazo</button>
                </div>
                
                <div class="form-group">
                    <label for="system-lock">Funga Mfumo</label>
                    <select id="system-lock">
                        <option value="unlocked">Fungua</option>
                        <option value="locked">Funga</option>
                    </select>
                    <button onclick="updateSystemLock()">Sasisha Hali ya Mfumo</button>
                </div>
                
                <h3>Thibitisha Malipo</h3>
                <div id="pending-payments-loading" class="loading">Inapakia malipo...</div>
                <table id="pending-payments-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Jina</th>
                            <th>Kiasi</th>
                            <th>Tarehe</th>
                            <th>Maelezo</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
                
                <button class="print-btn" onclick="printPaymentHistory()">Chapa Historia ya Malipo</button>
                <button class="logout-btn" onclick="logoutAdmin()">Toka</button>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="success-modal" class="success-modal">
        <div class="success-content">
            <h3><i class="fas fa-check-circle"></i> Mafanikio!</h3>
            <p id="success-message">Asante kwa kujisajiri, endelea na hatua ya kufanya malipo </p>
            <button class="close-modal" id="close-modal">Sawa</button>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>THIS PROGRAM POWER BY MCH HERMAN FAMILY </p>
        </div>
    </footer>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCWgfjdRaHlWKLnbcXDOyzQLdrn7K7V7OM",
            authDomain: "harusiii.firebaseapp.com",
            databaseURL: "https://harusiii-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "harusiii",
            storageBucket: "harusiii.firebasestorage.app",
            messagingSenderId: "299123180980",
            appId: "1:299123180980:web:580df8e27a034e8f14dee1",
            measurementId: "G-3L6PEWFFZ5"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Error initializing Firebase: ", error);
            alert("Hitilafu ya Firebase: Tafadhali angalia mtandao wako au usanidi wa Firebase.");
        }

        // Get Realtime Database references
        let db, contributorsRef, settingsRef, paymentHistoryRef;
        try {
            db = firebase.database();
            contributorsRef = db.ref('contributors');
            settingsRef = db.ref('settings');
            paymentHistoryRef = db.ref('paymentHistory');
            console.log("Realtime Database connected successfully");
        } catch (error) {
            console.error("Error connecting to Realtime Database: ", error);
            alert("Hitilafu ya Database: Tafadhali angalia usanidi wa Realtime Database.");
        }

        // Global variables
        let contributors = [];
        let paymentHistory = [];
        let isProcessing = false;
        let isAdminAuthenticated = false;
        let systemSettings = { isLocked: false, announcement: '' };
        const ADMIN_PASSWORD = "1340";
        const WEDDING_DATE = new Date('2025-10-03');

        // Calculate days remaining
        function calculateDaysRemaining() {
            const today = new Date();
            const timeDiff = WEDDING_DATE - today;
            const daysRemaining = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
            return daysRemaining > 0 ? daysRemaining : 0;
        }

        // Show loading state for tables
        function showLoading() {
            const contributorsLoading = document.getElementById('contributors-loading');
            const statusLoading = document.getElementById('status-loading');
            const pendingPaymentsLoading = document.getElementById('pending-payments-loading');
            
            if (contributorsLoading) contributorsLoading.style.display = 'block';
            if (statusLoading) statusLoading.style.display = 'block';
            if (pendingPaymentsLoading) pendingPaymentsLoading.style.display = 'block';
            
            const contributorsTbody = document.querySelector('#contributors-table tbody');
            const statusTbody = document.querySelector('#status-table tbody');
            const pendingPaymentsTbody = document.querySelector('#pending-payments-table tbody');
            
            if (contributorsTbody) contributorsTbody.innerHTML = '';
            if (statusTbody) statusTbody.innerHTML = '';
            if (pendingPaymentsTbody) pendingPaymentsTbody.innerHTML = '';
        }

        // Hide loading state for tables
        function hideLoading() {
            const contributorsLoading = document.getElementById('contributors-loading');
            const statusLoading = document.getElementById('status-loading');
            const pendingPaymentsLoading = document.getElementById('pending-payments-loading');
            
            if (contributorsLoading) contributorsLoading.style.display = 'none';
            if (statusLoading) statusLoading.style.display = 'none';
            if (pendingPaymentsLoading) pendingPaymentsLoading.style.display = 'none';
        }

        // Show success modal
        function showSuccessModal(message) {
            const modal = document.getElementById('success-modal');
            const messageEl = document.getElementById('success-message');
            if (modal && messageEl) {
                messageEl.textContent = message;
                modal.style.display = 'flex';
                setTimeout(hideSuccessModal, 5000);
            }
        }

        // Hide success modal
        function hideSuccessModal() {
            const modal = document.getElementById('success-modal');
            if (modal) modal.style.display = 'none';
        }

        // Show announcement modal
        function showAnnouncementModal() {
            const modal = document.getElementById('announcement-modal');
            const text = document.getElementById('announcement-text');
            if (modal && text && systemSettings.announcement) {
                text.textContent = systemSettings.announcement;
                modal.style.display = 'flex';
                setTimeout(hideAnnouncementModal, 10000);
            }
        }

        // Hide announcement modal
        function hideAnnouncementModal() {
            const modal = document.getElementById('announcement-modal');
            if (modal) modal.style.display = 'none';
        }

        // Show lock message
        function showLockMessage() {
            const lockMessage = document.getElementById('lock-message');
            if (lockMessage) {
                lockMessage.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        // Hide lock message
        function hideLockMessage() {
            const lockMessage = document.getElementById('lock-message');
            if (lockMessage) {
                lockMessage.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // Show error message
        function showErrorMessage(message, elementId = 'form-error') {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.add('active');
                setTimeout(() => {
                    errorDiv.textContent = '';
                    errorDiv.classList.remove('active');
                }, 5000);
            } else {
                alert(message);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded");
            
            // Update days remaining
            const daysRemainingEl = document.getElementById('days-remaining');
            if (daysRemainingEl) {
                daysRemainingEl.textContent = `Siku zinazobaki: ${calculateDaysRemaining()}`;
            }
            
            // Show loading overlay for 7 seconds
            const loadingOverlay = document.getElementById('loading-overlay');
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
    loadingOverlay.classList.add('hidden');
    if (systemSettings.isLocked) {
        showLockMessage();
    } else {
        showAnnouncementModal();
        document.body.style.overflow = 'auto';
    }
}, 2000); // 2000ms = 2 sekunde
            showLoading();
            
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    if (systemSettings.isLocked && tab.getAttribute('data-tab') !== 'admin') {
                        showLockMessage();
                        return;
                    }
                    console.log("Tab clicked:", tab.getAttribute('data-tab'));
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'admin') {
                        toggleAdminUI();
                    }
                    if (tabId === 'payment') {
                        populateContributorSelect();
                    }
                    if (tabId === 'contributors' || tabId === 'status' || tabId === 'dashboard' || tabId === 'admin') {
                        refreshData();
                    }
                });
            });
            
            setupRealTimeListener();
            
            const registrationForm = document.getElementById('registration-form');
            if (registrationForm) {
                registrationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (systemSettings.isLocked) {
                        showErrorMessage('Mfumo umefungwa kwa sasa. Huwezi kujisajiri.');
                        return;
                    }
                    console.log("Form submitted");
                    handleSubmit();
                });
            }
            
            const paymentForm = document.getElementById('payment-form');
            if (paymentForm) {
                paymentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (systemSettings.isLocked) {
                        showErrorMessage('Mfumo umefungwa kwa sasa. Huwezi kufanya malipo.', 'payment-error');
                        return;
                    }
                    console.log("Payment form submitted");
                    handlePaymentSubmit();
                });
            }
            
            const statusFilter = document.getElementById('status-filter');
            if (statusFilter) {
                statusFilter.addEventListener('change', function() {
                    console.log("Status filter changed to:", this.value);
                    refreshStatusTable();
                });
            }
            
            const contributorSelect = document.getElementById('contributor-select');
            if (contributorSelect) {
                contributorSelect.addEventListener('change', function() {
                    updateDebtInfo(this.value);
                });
            }
            
            const paymentType = document.getElementById('payment-type');
            if (paymentType) {
                paymentType.addEventListener('change', function() {
                    const contributorId = document.getElementById('contributor-select')?.value;
                    if (contributorId) updateDebtInfo(contributorId);
                });
            }
            
            const closeBtn = document.getElementById('close-modal');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    console.log("Closing success modal");
                    hideSuccessModal();
                    const dashboardTab = document.querySelector('.nav-tab[data-tab="dashboard"]');
                    if (dashboardTab) {
                        dashboardTab.click();
                    }
                });
            }
            
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('blur', function() {
                    console.log("Checking phone:", this.value);
                    checkDuplicatePhone(this.value);
                });
            }
        });

        // Check for duplicate phone numbers
        function checkDuplicatePhone(phone) {
            if (!phone) {
                console.log("No phone number provided");
                return;
            }
            
            const warning = document.getElementById('phone-warning');
            if (!warning) {
                console.log("Phone warning element not found");
                return;
            }
            
            const normalizedPhone = phone.replace(/[\s\-\(\)]/g, '');
            console.log("Checking for duplicate phone:", normalizedPhone);
            
            const duplicate = contributors.find(c => {
                const cPhone = c.phone ? c.phone.replace(/[\s\-\(\)]/g, '') : '';
                return cPhone === normalizedPhone;
            });
            
            if (duplicate) {
                console.log("Duplicate phone found:", normalizedPhone);
                warning.style.display = 'block';
                document.getElementById('submit-btn').disabled = true;
            } else {
                console.log("No duplicate phone found");
                warning.style.display = 'none';
                document.getElementById('submit-btn').disabled = false;
            }
        }

        // Handle registration form submission
        async function handleSubmit() {
            if (isProcessing) {
                console.log("Submission in progress, ignoring");
                return;
            }
            
            const firstName = document.getElementById('firstName')?.value.trim() || '';
            const middleName = document.getElementById('middleName')?.value.trim() || '';
            const lastName = document.getElementById('lastName')?.value.trim() || '';
            const phone = document.getElementById('phone')?.value.trim() || '';
            const region = document.getElementById('region')?.value.trim() || '';
            const amount = document.getElementById('amount')?.value || '';
            
            console.log("Form data:", { firstName, middleName, lastName, phone, region, amount });
            
            if (!firstName || !lastName || !phone || !region || !amount) {
                showErrorMessage('Tafadhali jaza kila sehemu inayotakiwa.');
                console.log("Validation failed: Missing required fields");
                return;
            }
            
            const phoneRegex = /^(\+?255|0)?(7|6)\d{8}$/;
            if (!phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''))) {
                showErrorMessage('Tafadhali ingiza namba ya simu ya sahihi ya Tanzania (mfano: 0712345678 au +255712345678)');
                console.log("Validation failed: Invalid phone number");
                return;
            }
            
            const normalizedPhone = phone.replace(/[\s\-\(\)]/g, '');
            const duplicate = contributors.find(c => {
                const cPhone = c.phone ? c.phone.replace(/[\s\-\(\)]/g, '') : '';
                return cPhone === normalizedPhone;
            });
            
            if (duplicate) {
                document.getElementById('phone-warning').style.display = 'block';
                showErrorMessage('Mtu mmoja tayari amejisajiriwa kwa namba hii ya simu.');
                console.log("Validation failed: Duplicate phone number");
                return;
            }
            
            isProcessing = true;
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn?.textContent || 'Wasilisha';
            if (submitBtn) {
                submitBtn.textContent = 'Inasajili...';
                submitBtn.disabled = true;
            }
            
            try {
                if (!contributorsRef) {
                    throw new Error("Realtime Database reference not available");
                }
                
                const contributor = {
                    firstName: firstName,
                    middleName: middleName,
                    lastName: lastName,
                    region: region,
                    phone: phone,
                    amount: parseInt(amount),
                    paidAmount: 0,
                    debt: parseInt(amount),
                    paid: false,
                    date: new Date().toISOString()
                };
                
                console.log("Attempting to save contributor:", contributor);
                
                const savePromise = contributorsRef.push(contributor);
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error("Operesheni imepitwa na wakati. Tafadhali jaribu tena.")), 10000);
                });
                
                await Promise.race([savePromise, timeoutPromise]);
                console.log("Contributor saved successfully");
                
                const form = document.getElementById('registration-form');
                if (form) {
                    form.reset();
                }
                document.getElementById('phone-warning').style.display = 'none';
                
                showSuccessModal('Asante kwa kujisajiri endelea na hatua ya kufanya malipo ');
                
            } catch (error) {
                console.error("Error adding contributor: ", error);
                showErrorMessage('Kumekuwa na hitilafu wakati wa kuhifadhi taarifa: ' + error.message);
            } finally {
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
                isProcessing = false;
            }
        }

        // Populate contributor select dropdown
        function populateContributorSelect() {
            const select = document.getElementById('contributor-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">Chagua Jina</option>';
            contributors.forEach(contributor => {
                const option = document.createElement('option');
                option.value = contributor.id;
                option.textContent = `${contributor.firstName} ${contributor.middleName ? contributor.middleName + ' ' : ''}${contributor.lastName}`;
                select.appendChild(option);
            });
        }

        // Update debt info in payment form
        function updateDebtInfo(contributorId) {
            const debtInfo = document.getElementById('debt-info');
            const paymentType = document.getElementById('payment-type')?.value;
            if (!debtInfo || !contributorId) return;
            
            const contributor = contributors.find(c => c.id === contributorId);
            if (!contributor) {
                debtInfo.textContent = '';
                return;
            }
            
            const debt = contributor.debt || contributor.amount;
            if (paymentType === 'partial') {
                debtInfo.textContent = `Deni lililobaki: TSh ${debt.toLocaleString()}`;
                debtInfo.classList.add('active');
            } else {
                debtInfo.textContent = '';
                debtInfo.classList.remove('active');
            }
        }

        // Handle payment form submission
        async function handlePaymentSubmit() {
            if (isProcessing) {
                console.log("Payment submission in progress, ignoring");
                return;
            }
            
            const contributorId = document.getElementById('contributor-select')?.value;
            const paymentType = document.getElementById('payment-type')?.value;
            const paymentAmount = parseInt(document.getElementById('payment-amount')?.value) || 0;
            const paymentDate = document.getElementById('payment-date')?.value;
            const paymentDetails = document.getElementById('payment-details')?.value.trim() || '';
            
            console.log("Payment data:", { contributorId, paymentType, paymentAmount, paymentDate, paymentDetails });
            
            if (!contributorId || !paymentType || !paymentAmount || !paymentDate) {
                showErrorMessage('Tafadhali jaza taarifa zote za malipo.', 'payment-error');
                return;
            }
            
            const contributor = contributors.find(c => c.id === contributorId);
            if (!contributor) {
                showErrorMessage('Mchangiaji hakupatikana.', 'payment-error');
                return;
            }
            
            if (paymentAmount > contributor.debt) {
                showErrorMessage(`Kiasi cha malipo kinazidi deni lililobaki (TSh ${contributor.debt.toLocaleString()}).`, 'payment-error');
                return;
            }
            
            isProcessing = true;
            const submitBtn = document.getElementById('payment-submit-btn');
            const originalText = submitBtn?.textContent || 'Hifadhi Malipo';
            if (submitBtn) {
                submitBtn.textContent = 'Inahifadhi...';
                submitBtn.disabled = true;
            }
            
            try {
                if (!paymentHistoryRef) {
                    throw new Error("Payment history reference not available");
                }
                
                const payment = {
                    contributorId,
                    name: `${contributor.firstName} ${contributor.middleName ? contributor.middleName + ' ' : ''}${contributor.lastName}`,
                    amount: paymentAmount,
                    date: paymentDate,
                    details: paymentDetails,
                    confirmed: false,
                    timestamp: new Date().toISOString()
                };
                
                console.log("Saving payment:", payment);
                await paymentHistoryRef.push(payment);
                console.log("Payment saved successfully");
                
                const form = document.getElementById('payment-form');
                if (form) form.reset();
                updateDebtInfo('');
                
                showSuccessModal('Asante malipo yako yamepokelewa yanasubili uthibitisho wa admin .');
                
            } catch (error) {
                console.error("Error saving payment: ", error);
                showErrorMessage('Hitilafu wakati wa kuhifadhi malipo: ' + error.message, 'payment-error');
            } finally {
                if (submitBtn) {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
                isProcessing = false;
            }
        }

        // Verify admin password
        function verifyAdminPassword() {
            const passwordInput = document.getElementById('admin-password');
            const password = passwordInput?.value;
            console.log("Verifying admin password");
            
            if (password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-panel').classList.add('active');
                refreshPendingPayments();
                showErrorMessage('Nenosiri sahihi. Unaweza sasa kudhibiti mfumo.', 'admin-error');
            } else {
                showErrorMessage('Nenosiri sio sahihi. Tafadhali jaribu tena.', 'admin-error');
            }
            if (passwordInput) passwordInput.value = '';
        }

        // Logout from admin mode
        function logoutAdmin() {
            console.log("Logging out of admin mode");
            isAdminAuthenticated = false;
            document.getElementById('admin-login').style.display = 'block';
            document.getElementById('admin-panel').classList.remove('active');
            refreshPendingPayments();
        }

        // Toggle admin UI
        function toggleAdminUI() {
            const adminLogin = document.getElementById('admin-login');
            const adminPanel = document.getElementById('admin-panel');
            
            if (isAdminAuthenticated) {
                adminLogin.style.display = 'none';
                adminPanel.classList.add('active');
            } else {
                adminLogin.style.display = 'block';
                adminPanel.classList.remove('active');
            }
        }

        // Post announcement
        async function postAnnouncement() {
            const announcement = document.getElementById('announcement')?.value.trim();
            if (!announcement) {
                showErrorMessage('Tafadhali andika tangazo.', 'admin-error');
                return;
            }
            
            try {
                if (!settingsRef) {
                    throw new Error("Settings reference not available");
                }
                console.log("Posting announcement:", announcement);
                await settingsRef.update({ announcement });
                console.log("Announcement posted successfully");
                document.getElementById('announcement').value = '';
                showErrorMessage('Tangazo limechapishwa.', 'admin-error');
            } catch (error) {
                console.error("Error posting announcement: ", error);
                showErrorMessage('Hitilafu wakati wa kuchapisha tangazo: ' + error.message, 'admin-error');
            }
        }

        // Update system lock status
        async function updateSystemLock() {
            const systemLock = document.getElementById('system-lock')?.value === 'locked';
            try {
                if (!settingsRef) {
                    throw new Error("Settings reference not available");
                }
                console.log("Updating system lock status:", systemLock);
                await settingsRef.update({ isLocked: systemLock });
                console.log("System lock status updated successfully");
                showErrorMessage('Hali ya mfumo imesasishwa.', 'admin-error');
            } catch (error) {
                console.error("Error updating system lock: ", error);
                showErrorMessage('Hitilafu wakati wa kusasisha hali ya mfumo: ' + error.message, 'admin-error');
            }
        }

        // Confirm payment
        async function confirmPayment(paymentId, contributorId, amount) {
            console.log("Confirming payment:", { paymentId, contributorId, amount });
            
            try {
                if (!paymentHistoryRef || !contributorsRef) {
                    throw new Error("Database references not available");
                }
                
                const contributor = contributors.find(c => c.id === contributorId);
                if (!contributor) {
                    throw new Error("Contributor not found");
                }
                
                const newPaidAmount = (contributor.paidAmount || 0) + amount;
                const updateData = {
                    paidAmount: newPaidAmount,
                    debt: contributor.amount - newPaidAmount,
                    paid: newPaidAmount >= contributor.amount
                };
                
                await contributorsRef.child(contributorId).update(updateData);
                await paymentHistoryRef.child(paymentId).update({ confirmed: true });
                console.log("Payment confirmed successfully");
                refreshPendingPayments();
                refreshData();
            } catch (error) {
                console.error("Error confirming payment: ", error);
                showErrorMessage('Hitilafu wakati wa kuthibitisha malipo: ' + error.message, 'admin-error');
            }
        }

        // Print payment history
        function printPaymentHistory() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Historia ya Malipo - Harusi ya Julius Herman</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { text-align: center; color: #ff6f91; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5eef8; }
                    </style>
                </head>
                <body>
                    <h1>Historia ya Malipo - Harusi ya Julius Herman</h1>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Jina</th>
                                <th>Kiasi</th>
                                <th>Tarehe</th>
                                <th>Maelezo</th>
                                <th>Hali</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${paymentHistory.map((payment, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${payment.name}</td>
                                    <td>TSh ${payment.amount.toLocaleString()}</td>
                                    <td>${new Date(payment.date).toLocaleDateString('sw-TZ')}</td>
                                    <td>${payment.details || 'Hakuna'}</td>
                                    <td>${payment.confirmed ? 'Imethibitishwa' : 'Inasubiri'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Set up real-time listener for Realtime Database
        function setupRealTimeListener() {
            if (!contributorsRef || !settingsRef || !paymentHistoryRef) {
                console.error("Realtime Database reference not available");
                hideLoading();
                showErrorMessage('Hakikisha kuvumbua kwa mtandao kisha jaribu tena.');
                return;
            }
            
            // Listen for contributors
            contributorsRef.on('value', (snapshot) => {
                console.log("Realtime contributor data received");
                contributors = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        contributors.push({
                            id: key,
                            ...data[key]
                        });
                    });
                }
                console.log("Contributors updated:", contributors);
                hideLoading();
                populateContributorSelect();
                refreshData();
            }, (error) => {
                console.error("Error fetching contributors: ", error);
                hideLoading();
                showErrorMessage('Kumekuwa na tatizo la mtandao: ' + error.message);
            });
            
            // Listen for settings
            settingsRef.on('value', (snapshot) => {
                console.log("Realtime settings data received");
                const data = snapshot.val();
                systemSettings = data || { isLocked: false, announcement: '' };
                console.log("Settings updated:", systemSettings);
                
                if (systemSettings.isLocked) {
                    showLockMessage();
                } else {
                    hideLockMessage();
                    showAnnouncementModal();
                }
                
                const systemLockSelect = document.getElementById('system-lock');
                if (systemLockSelect) {
                    systemLockSelect.value = systemSettings.isLocked ? 'locked' : 'unlocked';
                }
            }, (error) => {
                console.error("Error fetching settings: ", error);
                showErrorMessage('Kumekuwa na tatizo la mtandao: ' + error.message);
            });
            
            // Listen for payment history
            paymentHistoryRef.on('value', (snapshot) => {
                console.log("Realtime payment history data received");
                paymentHistory = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        paymentHistory.push({
                            id: key,
                            ...data[key]
                        });
                    });
                }
                console.log("Payment history updated:", paymentHistory);
                refreshPendingPayments();
            }, (error) => {
                console.error("Error fetching payment history: ", error);
                showErrorMessage('Kumekuwa na tatizo la mtandao: ' + error.message);
            });
        }

        // Refresh all data
        function refreshData() {
            console.log("Refreshing data");
            refreshDashboard();
            refreshContributorsTable();
            refreshStatusTable();
        }

        // Refresh dashboard
        function refreshDashboard() {
            console.log("Refreshing dashboard");
            const totalContributors = contributors.length;
            const totalAmount = contributors.reduce((sum, c) => sum + (c.amount || 0), 0);
            const paidContributors = contributors.filter(c => c.paid).length;
            
            const totalContributorsEl = document.getElementById('total-contributors');
            const totalAmountEl = document.getElementById('total-amount');
            const paidContributorsEl = document.getElementById('paid-contributors');
            
            if (totalContributorsEl) totalContributorsEl.textContent = totalContributors;
            if (totalAmountEl) totalAmountEl.textContent = `TSh ${totalAmount.toLocaleString()}`;
            if (paidContributorsEl) paidContributorsEl.textContent = paidContributors;
        }

        // Refresh contributors table
        function refreshContributorsTable() {
            console.log("Refreshing contributors table");
            const tbody = document.querySelector('#contributors-table tbody');
            if (!tbody) {
                console.log("Contributors table body not found");
                return;
            }
            
            tbody.innerHTML = '';
            
            contributors.forEach((contributor, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${contributor.firstName} ${contributor.middleName ? contributor.middleName + ' ' : ''}${contributor.lastName}</td>
                    <td>${contributor.region}</td>
                    <td>${contributor.phone}</td>
                    <td>TSh ${contributor.amount.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Refresh status table
        function refreshStatusTable() {
            console.log("Refreshing status table");
            const filter = document.getElementById('status-filter')?.value || 'all';
            const tbody = document.querySelector('#status-table tbody');
            if (!tbody) {
                console.log("Status table body not found");
                return;
            }
            
            tbody.innerHTML = '';
            
            let filteredContributors = contributors;
            if (filter === 'paid') {
                filteredContributors = contributors.filter(c => c.paid);
            } else if (filter === 'partial') {
                filteredContributors = contributors.filter(c => c.paidAmount > 0 && !c.paid);
            } else if (filter === 'pending') {
                filteredContributors = contributors.filter(c => !c.paid && (!c.paidAmount || c.paidAmount === 0));
            }
            
            filteredContributors.forEach((contributor, index) => {
                const debt = (contributor.amount || 0) - (contributor.paidAmount || 0);
                const status = contributor.paid ? 'Ameshachangia' : (contributor.paidAmount > 0 ? 'Ametanguliza' : 'Hajachangia');
                const statusClass = contributor.paid ? 'paid' : (contributor.paidAmount > 0 ? 'partial' : 'pending');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${contributor.firstName} ${contributor.middleName ? contributor.middleName + ' ' : ''}${contributor.lastName}</td>
                    <td>TSh ${contributor.amount.toLocaleString()}</td>
                    <td>TSh ${(contributor.paidAmount || 0).toLocaleString()}</td>
                    <td>TSh ${debt.toLocaleString()}</td>
                    <td class="${statusClass}">${status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Refresh pending payments table
        function refreshPendingPayments() {
            console.log("Refreshing pending payments table");
            const tbody = document.querySelector('#pending-payments-table tbody');
            if (!tbody) {
                console.log("Pending payments table body not found");
                return;
            }
            
            tbody.innerHTML = '';
            
            const pendingPayments = paymentHistory.filter(p => !p.confirmed);
            pendingPayments.forEach((payment, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${payment.name}</td>
                    <td>TSh ${payment.amount.toLocaleString()}</td>
                    <td>${new Date(payment.date).toLocaleDateString('sw-TZ')}</td>
                    <td>${payment.details || 'Hakuna'}</td>
                    <td>
                        ${isAdminAuthenticated ? `
                            <button onclick="confirmPayment('${payment.id}', '${payment.contributorId}', ${payment.amount})">Thibitisha</button>
                        ` : 'Inasubiri'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            hideLoading();
        }
    </script>
</body>
</html>
